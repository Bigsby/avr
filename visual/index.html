<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        div.byteContainer {
            display: flex;
            flex-direction: row;
            font-family: monospace;
        }

        div.bitContainer {
            display: flex;
            flex-direction: row;
        }

        div.wrapped {
            border: 1px solid black;
            display: table;
            padding: 2px;
            margin: 2px;
        }

        div.wrapped span.title {
            text-align: center;
            font-weight: bold;
            width: 100%;
            display: inline-block;
            border-bottom: 1px solid black;
        }

        .registers-container {
            /* max-height: 200px; */
            width: 604px;
            display: flex;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>AVR CPU</h1>
        <div>
            <clock></clock>
            <bus :value="bus_value"></bus>
            <program-counter></program-counter>
            <memory name="Flash" :address="flash_address"></memory>
            <alu :target_operand="alu.target_operand" :source_operand="alu.source_operand"></alu>
            <instruction :op_code="op_code"></instruction>
            <memory name="RAM" :address="ram_address"></memory>
            <boxed-component title="Registers" color="skyblue" container_class="registers-container">
                <register v-for="register in registers" :value="register.value" :index="register.index"></register>
            </boxed-component>
        </div>
    </div>
    <script>
        const REGISTER_COUNT = 32;
        const BUS_WIDTH = 8;
        const RAM_SIZE = 16;
        const OPCODE_WIDTH = 16;
        const CLOCK_INTERVAL = 500;

        let registers = [];
        for (let registerIndex = 0; registerIndex < REGISTER_COUNT; registerIndex++) {
            registers.push({
                index: registerIndex,
                value: registerIndex
            });
        }

        const initial_data = {
            alu: {
                bus_width: BUS_WIDTH,
                target_operand: 5 | 1,
                source_operand: 255
            },
            registers: registers,
            bus_value: 2,
            ram_address: 0,
            flash_address: 0,
            op_code: 0xba4
        };

        Vue.component("bus", {
            template: `
                <boxed-component title="Bus" color="yellow">
                    <byte :value="value"></byte>
                </boxed-component>        
            `,
            props: ["value"],
        });

        Vue.component("program-counter", {
            template: `
            <boxed-component title="P-Counter" color="lightblue">
                <byte :value="innerValue"></byte>
            </boxed-component>
            `,
            props: ["value", "in", "out"],
            created() {
                this.innerValue = this.value || 0;
            }
        });

        Vue.component("clock", {
            template: `
            <boxed-component title="Clock">
                <span>{{value ? "HIGH": "LOW"}}</span>
            </boxed-component>
            `,
            data() {
                return { value: false };
            },
            created() {
                setInterval(function () {
                    this.value = !this.value;
                }.bind(this), CLOCK_INTERVAL);
            }
        });

        Vue.component("instruction", {
            template: `
            <boxed-component title="Instruction" color="lightpink">
                <boxed-component title="Higher" color="lightgreen">
                    <byte :value="op_code >> 8"></byte>
                </boxed-component>
                <boxed-component title="Lower" color="lightred">
                    <byte :value="op_code & 0xff"></byte>
                </boxed-component>
            </boxed-component>
            `,
            props: ["op_code", "in"]
        });

        Vue.component("memory", {
            template: `
            <boxed-component :title="name" color="lightpink">
                <boxed-component title="Address" color="lightsalmon">
                    <byte :value="address"></byte>
                </boxed-component>
                <boxed-component title="Value" color="indianred">
                    <byte :value="innerValue"></byte>
                </boxed-component>
            </boxed-component>
            `,
            props: ["name", "address", "value", "in", "out"],
            watch: {
                address: function (newAddress) {
                    this.value = 0;
                },
                value: function (newValue) {
                    this.innerValue = newValue;
                }
            },
            created() {
                this.innerValue = this.value || 0;
            }
        });

        // Vue.component("ram", {
        //     template: `
        //     <boxed-component title="RAM" color="lightpink">
        //         <boxed-component title="Address" color="lightsalmon">
        //             <byte :value="address"></byte>
        //         </boxed-component>
        //         <boxed-component title="Value" color="indianred">
        //             <byte :value="innerValue"></byte>
        //         </boxed-component>
        //     </boxed-component>
        //     `,
        //     props: ["address", "value", "in", "out"],
        //     watch: {
        //         address: function (newAddress) {
        //             this.value = 0;
        //         },
        //         value: function (newValue) {
        //             this.innerValue = newValue;
        //         }
        //     },
        //     created() {
        //         this.innerValue = this.value || 0;
        //     }
        // });

        Vue.component("register", {
            template: `
            <boxed-component :title="'R' + index" color="lightblue">
                <byte :value="value"></byte>
            </boxed-component>
            `,
            props: ["value", "index", "in", "out"]
        });

        Vue.component("boxed-component", {
            template: `
                <div class="wrapped">
                    <span class="title" :style="{ background: color }">{{title}}</span>
                    <div :class="container_class">
                        <slot></slot>
                    </div>
                </div>
            `,
            props: ["title", "color", "container_class"]
        });
        Vue.component("byte", {
            template: `
                <div class="byteContainer">
                    <div class="bitContainer">
                        <div v-for="bit in BUS_WIDTH()">{{bitValue(bit,value || 0)}}</div>
                    </div>
                    - {{toHexString(value || 0)}} - {{toDecimalString(value)}}
                </div>`,
            props: ["value"],
            methods: {
                toHexString: function (value) {
                    let str = value.toString(16).toUpperCase();;
                    return "0".repeat((BUS_WIDTH / 4) - str.length) + str;
                },
                toDecimalString: function (value) {
                    let str = value.toString();
                    return "0".repeat(Math.pow(2, BUS_WIDTH).toString().length - str.length) + str;
                },
                bitValue: function (bit, value) {
                    return Math.pow(2, BUS_WIDTH - bit) & value ? 1 : 0;
                },
                BUS_WIDTH: function () {
                    return BUS_WIDTH;
                }
            }
        });

        Vue.component("alu", {
            template: `
            <boxed-component title="ALU" color="lightgrey">
                <boxed-component title="Target" color="lightgreen">
                    <byte :value="target_operand"></byte>
                </boxed-component>
                <boxed-component title="Source" color="coral">
                    <byte :value="source_operand"></byte>
                </boxed-component>
                <boxed-component title="Status" color="	greenyellow">
                    <byte :value="source_operand"></byte>
                </boxed-component>
            </boxed-component>
            `,
            props: ["target_operand", "source_operand", "out"]
        });

        let app = new Vue({
            el: "div#app",
            data: initial_data
        });
    </script>
</body>

</html>